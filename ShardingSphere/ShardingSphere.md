# ShardingSphere

分库分表

Sharding-JDBC分库分表操作

Sharding-Proxy分库分表操作

什么是ShardingSphere?

- 一套开源的分布式数据库中间件解决方案
- 由3个产品组成：
  - Sharding-JDBC
  - Sharding-Proxy

- 关系型数据库中间件，标准化的数据分片、分布式事务、数据治理



## Sharding-JDBC

轻量级的Java框架

 

## Sharding-Proxy

透明化的数据库代理端

- 向应用程序完全透明，可直接作为Mysql/PostgereSQL使用



## 分库分表

为什么要分库分表

分库分表的方式：

- 垂直切分
  - 垂直分库
  - 垂直分表
- 水平切分
  - 水平分库
  - 水平分表



### 垂直分表

把数据库中某张表中的一部分字段存储到一张新表中，再把其他字段存储到另一张表中。



### 垂直分库

把单一的数据库，按照业务进行划分，做到专库专表。



### 水平分库

创建多个相同结构i的数据库，根据ID是奇数或偶数进行不同数据库的存储。

### 水平分表

一个库中存在多张结构相同的表，根据ID来判断存储在那张表中。

### 分库分表的应用

### 分库分表的问题

- 跨节点连接查询问题（分页）：多个数据库的数据需要连接查询
- 多数据源管理问题：多个数据源不易管理



## Sharding-JDBC

### 简介

- 轻量级的Java开发框架，增强版的JDBC驱动

- Sharding-JDBC不是做分库分表：需要先做好分库分表，然后通过Sharding-JDBC去操作多个数据库，多个表

- 主要目的：简化对分库分表数据的操作

### Sharding-JDBC实现水平分表

1. 搭建环境

   SpringBoot+MyBatisPlus+Sharding-JDBC+Druid连接池

   （1）创建SpringBoot项目

   （2）引入相关依赖

   （3）添加启动类和配置文件，等待等下的业务操作

   

2. 创建数据库，创建数据库表

   （1）创建数据库

   （2）创建两张相同的表，用于进行水平分表

3. 编写代码，实现分库分表数据的操作

   （1）创建实体类，创建Mapper

   （2）创建启动类，添加Mapper的包扫描注解

4. 配置Sharding-JDBC分片策略

   在项目的application.properties文件中配置，可以从官网查看。

   SpringBoot配置示例：

   ```properties
   ##Sharding-JDBC分片策略配置
   #1、配置数据源，给数据源起名字
   #2、配置数据源的具体内容，包含连接池、驱动、地址、用户名和密码
   #3、指定表分布情况，配置表在那个数据库，表的名称是什么
   #4、指定表中主键的生成策略
   #5、指定分片的策略
   #6、打开SQL的输出日志
   ```

   #

5. 编写测试代码，完成测试

   ```
   #1、创建一个SpringBoot测试类
   #2、创建实体类，通过Mapper进行添加操作。
   #3、出现错误，是因为一个实体类不能对应两个表，需要在配置文件中添加配置。
   #4、在测试，通过循环进行插入，可以看到插入了两张表
   
   查询测试
   
   ```

   

6. 

### Sharding-JDBC水平分库

1. 创建两个数据

2. 分别在两个数据库中创建两个相同的表

3. 约定规则：userid为偶数，添加到第一个数据库中；userid为奇数，添加到第二个数据库。code编码时偶数存储到表一中，code编码是奇数存储到表二中。

4. 在springboot配置文件中配置数据库分片的规则

   ```
   ##Sharding-JDBC分片策略配置
   #1、配置数据源，给各个数据源起名字
   #2、配置各个数据源的具体内容，包含连接池、驱动、地址、用户名和密码
   #3、指定数据库的分布情况，指定数据库中表的分布情况
   #4、指定表中主键的生成策略
   #5、指定数据库的分片策略和数据表的分片策略
   #6、打开SQL的输出日志
   ```

5. 编写测试方法，进行测试

### Sharding-JDBC垂直分库

1. 需求：实现专库专表，每个数据库只存储一个业务块的数据

2. 创建对应个业务块的数据库和表

3. 编写操作代码

   1. 创建user的实体类和Mapper

4. 配置垂直分库的策略

   配置user_db数据库里的表user，专库专表

5. 

### Sharding-JDBC 公共表

1. 公共表：存储固定数据的表，表中数据很少修改，查询时经常关联
2. 在每个数据库中都创建相同结构的公共表
3. 配置文件中进行公共表的配置
4. 创建dict的实体类和Mapper
5. 编写测试类，添加后三个表中都有数据，删除时三个表中数据i都会被删除

### Sharding-JDBC  读写分离

1. 读写分离
2. Mysql配置读写分离
3. Sharding-JDBC并不做数据同步，只是做数据操作的路由

#### Mysql配置读写分离

1、创建两个Mysql数据库

2、配置Mysql中的主从服务器

3、创建主从复制的账号

4、创建主从同步的设置

#### Sharding-JDBC读写分离配置



## Sharding-Proxy

透明化的数据库代理端

### Sharding-Proxy代理



### Sharding-proxy读写分离



